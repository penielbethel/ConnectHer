<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ConnectHer - Access</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      box-sizing: border-box;
    }

    body, html {
      width: 100%;
      height: 100%;
      background: #0e0e0e;
      color: #fff;
    }

    #preloader {
      position: fixed;
      width: 100%;
      height: 100%;
      background: #0e0e0e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    #preloader img {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
    }

    .dot-container {
      display: flex;
      justify-content: center;
      gap: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      background: #ccc;
      border-radius: 50%;
      animation: blink 1.2s infinite ease-in-out;
    }

    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    .dot:nth-child(4) { animation-delay: 0.6s; }
    .dot:nth-child(5) { animation-delay: 0.8s; }

    @keyframes blink {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }

    #preloader .meta-text {
      margin-top: 30px;
      font-size: 14px;
      color: #aaa;
    }

    .container {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      max-width: 500px;
      margin: 0 auto;
    }

    .container img {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      border-radius: 12px;
    }

    h1, h2 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #ffcce6;
      text-align: center;
    }

    p {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 20px;
      text-align: center;
    }

    form {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 15px;
    }

    input {
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: #1a1a1a;
      color: #ffcce6;
      font-size: 16px;
      box-shadow: 0 0 8px #ff66cc40;
    }

    button {
      padding: 14px;
      background: #ff99cc;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      color: #0e0e0e;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #ff66b2;
    }

    .error {
      color: red;
      text-align: center;
      font-size: 14px;
    }

    .toggle-link {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
    }

    .toggle-link a {
      color: #ff99cc;
      text-decoration: underline;
      cursor: pointer;
    }

    .forgot {
      text-align: center;
      font-size: 14px;
    }

    .forgot a {
      color: #ff99cc;
      text-decoration: none;
    }

    @media screen and (max-width: 480px) {
      .container {
        padding: 30px 15px;
      }

      h1, h2 {
        font-size: 20px;
      }

      input, button {
        font-size: 15px;
        padding: 12px;
      }

      .container img {
        width: 60px;
        height: 60px;
      }
      select {
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: #1a1a1a;
  color: #ffcce6;
  font-size: 16px;
  box-shadow: 0 0 8px #ff66cc40;
}
    }

    select {
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: #1a1a1a;
  color: #ffcce6;
  font-size: 16px;
  box-shadow: 0 0 8px #ff66cc40;
}
  </style>
</head>
<body>

<!-- Preloader -->
<div id="preloader">
  <img src="https://i.imgur.com/C4WBqmd.png" alt="ConnectHer Logo">
  <div class="dot-container">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>
  <div class="meta-text">ConnectHer 2025</div>
</div>

<!-- Sign-Up Container -->
<div id="signup-container" class="container">
  <img src="https://i.imgur.com/C4WBqmd.png" alt="ConnectHer Logo">
  <h1>Sign Up for ConnectHer</h1>
  <form id="signup-form" enctype="multipart/form-data">
  <input type="text" name="firstName" placeholder="First name" required>
  <input type="text" name="surname" placeholder="Surname" required>
  <input type="text" name="username" placeholder="Choose a username" required>
  <input type="email" name="email" placeholder="Email address" required>
  <div style="position: relative;">
    <input type="password" name="password" id="signupPassword" placeholder="Password" required>
  </div>
  <select name="gender" id="gender" required>
  <option value="Female" selected>Female</option>
  <option value="Company">Company</option>
</select>
  <input type="date" name="birthday" placeholder="Birthday" required>
  <input type="text" name="location" id="location" placeholder="Location" required>
  <input type="file" name="avatar" accept="image/*" required>
  <input type="text" name="adminToken" placeholder="Admin Token (if provided)" />
  <button type="submit">Sign Up</button>
  <div class="error" id="errorMsg"></div>
</form>

  <div class="toggle-link">Already Registered? <a onclick="toggleView('login')">Login Here</a></div>
</div>

<!-- Login Container -->
<div id="login-container" class="container">
  <img src="https://i.imgur.com/C4WBqmd.png" alt="ConnectHer Logo">
  <h2>Login</h2>
  <p>Sign in to continue</p>
  <form id="login-form">
    <input type="text" name="username" placeholder="Username/Email" required>
    <input type="password" name="password" placeholder="Password" required>
    <button type="submit">Log In</button>
    <div class="error" id="loginErrorMsg"></div>
  </form>
  <div class="forgot"><a href="#">Forgot Password?</a></div>
  <div class="toggle-link">New user? <a onclick="toggleView('signup')">Sign Up Here</a></div>

<script>
  // 🚪 If already logged in, redirect to dashboard
  if (localStorage.getItem("username")) {
    window.location.replace("dashboard.html");

  }

  // 🌐 Preloader transition
  window.addEventListener('load', () => {
    setTimeout(() => {
      document.getElementById('preloader').style.display = 'none';
      document.getElementById('signup-container').style.display = 'flex';
    }, 3000);
  });

  // 🔁 Toggle between Signup/Login views
  function toggleView(view) {
    document.getElementById('signup-container').style.display = view === 'signup' ? 'flex' : 'none';
    document.getElementById('login-container').style.display = view === 'login' ? 'flex' : 'none';
  }

  // 📍 Auto-fill location using browser geolocation
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition((position) => {
      const { latitude, longitude } = position.coords;
      document.getElementById('location').value = `Lat: ${latitude}, Lng: ${longitude}`;
    });
  }

  // 📝 Signup form submission
  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;

    const formData = new FormData();
    formData.append("firstName", form.firstName.value);
    formData.append("surname", form.surname.value);
    formData.append("name", `${form.firstName.value} ${form.surname.value}`);
    formData.append("username", form.username.value);
    formData.append("email", form.email.value);
    formData.append("password", form.password.value);
    formData.append("birthday", form.birthday.value);
    formData.append("location", form.location.value);
    formData.append("gender", form.gender.value);
    formData.append("avatar", form.avatar.files[0]);
    formData.append("adminToken", form.adminToken.value);

    try {
      const res = await fetch('http://localhost:3000/api/auth/register', {
        method: 'POST',
        body: formData
      });

      const response = await res.json();

      if (res.ok) {
        const user = response.user;

        // ✅ ADDED JOINED DATE FIX
        if (!user.joined) {
          user.joined = new Date().toISOString().split("T")[0];
        }

        // ✅ Save logged-in user
        if (!user.name && user.firstName && user.surname) {
          user.name = `${user.firstName} ${user.surname}`;
        }

        localStorage.setItem("currentUser", JSON.stringify({
  username: user.username,
  name: user.name || `${user.firstName} ${user.surname}`,
  firstName: user.firstName,
  surname: user.surname,
  avatar: user.avatar,
  location: user.location,
  role: user.role
}));
        localStorage.setItem("username", user.username);

        // Optional: include in allUsers
        let allUsers = JSON.parse(localStorage.getItem("allUsers")) || [];
        allUsers = allUsers.filter(u => u.username !== user.username); // Remove any existing
        allUsers.push(user);
        localStorage.setItem("allUsers", JSON.stringify(allUsers));
        localStorage.setItem("pendingUser", JSON.stringify(user));
        window.location.replace("verification.html");
      } else {
        document.getElementById('errorMsg').textContent = response.message || "Registration failed.";
      }
    } catch {
      document.getElementById('errorMsg').textContent = "Cannot connect to server.";
    }
  });

 // 🔐 Login form submission (UPDATED)
document.getElementById('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const input = e.target.username.value.trim();
  const password = e.target.password.value;

  try {
    const res = await fetch('http://localhost:3000/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ identifier: input, password }) // username or email
    });

    const data = await res.json();
    if (res.ok) {
      alert("✅ Login successful!");
      e.target.reset();

      const user = data.user;

      // ✅ Save token
      if (data.token) {
        localStorage.setItem("token", data.token);
      }

      // ✅ Ensure missing data is patched
      if (!user.joined) {
        user.joined = new Date().toISOString().split("T")[0];
      }
      if (!user.name && user.firstName && user.surname) {
        user.name = `${user.firstName} ${user.surname}`;
      }

      // ✅ Store user info
      localStorage.setItem("username", user.username);
      localStorage.setItem("currentUser", JSON.stringify(user));

      // 🔁 Optional: Keep local cache of all users
      let allUsers = JSON.parse(localStorage.getItem("allUsers")) || [];
      allUsers = allUsers.filter(u => u.username !== user.username);
      allUsers.push(user);
      localStorage.setItem("allUsers", JSON.stringify(allUsers));

      // 🔁 Role-based redirect
      if (user.role === "superadmin") {
        window.location.replace("superAdminPanel.html");
      } else if (user.role === "admin") {
        window.location.replace("adminPanel.html");
      } else {
        window.location.replace("dashboard.html");
      }

    } else {
      document.getElementById('loginErrorMsg').textContent = data.message || "Login failed.";
    }

  } catch (err) {
    console.error("Login Error:", err);
    document.getElementById('loginErrorMsg').textContent = "Cannot connect to server.";
  }
});

  // 👁️ Toggle password visibility
  function togglePassword(inputId, iconElement) {
    const input = document.getElementById(inputId);
    if (input.type === "password") {
      input.type = "text";
      iconElement.textContent = "🙈";
    } else {
      input.type = "password";
      iconElement.textContent = "👁️";
    }
  }
</script>


</body>
</html>
